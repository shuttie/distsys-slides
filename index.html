<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Страх и ненависть в распределенных системах</title>

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/beige.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section data-background="images/fear_loathing.jpg">
					<h1>Страх <br/>и<br/> ненависть</h1>
					<h3>в распределенных системах</h3>
					<p>
						<small>Гребенников Роман / <a href="http://findify.io">Findify.io</a> / <a href="http://twitter.com/public_void_grv">@public_void_grv</a></small>
					</p>
					<p><small>&copy; jpoint 2016</small></p>
				</section>
				<section>
					<h2>Обо мне</h2>
					<img src="images/grebennikov.jpg"/>
					<p>
					  <small>twitter: <a href="http://twitter.com/public_void_grv">public_void_grv</a></small>
						<small>email: <a href="mailto:grv@dfdx.me">grv@dfdx.me</a></small>
				  </p>
					<p class="fragment">
					  <img class="plain" height="60px" src="images/sociohub.png"/>
					  <img class="plain" height="60px" src="images/findify.png"/>
					</p>
				</section>
				<!--section>
					<h2>Intro</h2>
					<img src="images/two_hard_problems.png" class="plain"/>
				</section-->
				<section>
					<h2>Intro</h2>
					<p>
					<ul>
						<li class="fragment"><span style="color: grey;">(серверное)</span> приложение</li>
						<li class="fragment">внутреннее состояние</li>
						<li class="fragment">перестало помещаться в один сервер?</li>
					</ul>
				  </p>
					<p><img class="fragment" src="images/vinni_in_the_hole.jpg"/></p>
				</section>
				<section>
					<h2>Куда расти?</h2>
					<p>
						<ul>
							<li class="fragment">сервер помощнее</li>
							<li class="fragment">оптимизация</li>
							<li class="fragment">распределенная система</li>
						</ul>
					</p>
					<p><img class="fragment" style="height: 350px;" src="images/vinni_mosaic.jpg"/></p>
				</section>
				<section>
					<h2>Агенда</h2>
					<p>
						<ul>
							<li class="fragment">распределенные системы повсюду</li>
							<li class="fragment">
								как прострелить ногу: теория
								<ul style="color: grey; font-size: 20pt;">
									<li>консистентность</li>
									<li>подходы к проектированию</li>
									<li>инструменты</li>
								</ul>
							</li>
							<li class="fragment">
								как прострелить ногу: практика
								<ul style="color: grey; font-size: 20pt;">
									<li>Распределенная "БД" на 100 строк</li>
									<li>шатание и ломание</li>
								</ul>
							</li>
							<li class="fragment">как с этим жить</li>
						</ul>
					</p>
				</section>
				<section>
					<h2>Пример из жизни</h2>
					<p>
						Веб-скрейпер, с общей очередью задач.
					</p>
					<ul>
						<li class="fragment">взять из очереди</li>
						<li class="fragment">положить в очередь</li>
						<li class="fragment">проверить, есть ли обьект в очереди</li>
					</ul>
					<p class="fragment">
						Очередь целиком не помещается в RAM.
						<img height="250px" src="images/long_queue.jpg"/>
					</p>

				</section>
				<section>
					<h2>Пример: шардинг</h2>
					<p>Разбить всю очередь на блоки</p>
					<img class="plain" height="170px" src="images/sharding.svg" style=""/>
					<ul>
						<li class="fragment">Каждый сервер работает в рамках своего блока</li>
						<li class="fragment">взять из очереди = ок<span style="color: red;">*</span></li>
						<li class="fragment">положить в очередь = ок<span style="color: red;">*</span></li>
						<li class="fragment">проверить, есть ли в очереди = ок<span style="color: red;">*</span></li>
					</ul>
					<p class="fragment"><span style="color: red;">*</span> - #тяжеловато</p>
				</section>
				<section>
					<h2>Problems, officer?</h2>
					<p class="fragment">Больше компонентов = меньше надежность системы</p>
					<p class="fragment">Что-то обязательно поломается: софт, железо, <span class="fragment highlight-red">сеть.</span></p>
					<p class="fragment">
					  <img height="300px" src="images/ms_net_failures.png"/>
						<small><a href="http://research.microsoft.com/en-us/um/people/navendu/papers/sigcomm11netwiser.pdf">[1]: P.Gill, Understanding network failures in data centers: measures, analysis and implications</a></small>
						<small><a href="https://aphyr.com/posts/288-the-network-is-reliable">[2]: Aphyr / K.Kingsbury: The network is reliable, 2013</a></small>
				  </p>
				</section>
				<section>
					<h2>Распределенность</h2>
					<p class="fragment">Взаимодействие по сети: <span class="fragment">нарушение связанности</span></p>
					<p class="fragment">
						NETSPLIT<br/>
					  <img height="400px" src="images/netsplit.svg"/>
					</p>
				</section>
				<section>
					<h2>Netsplit и шардинг</h2>
					<ul>
						<li class="fragment">взять из очереди = <span class="fragment" style="color: red;">fail</span></li>
						<li class="fragment">проверить, есть ли в очереди = <span class="fragment" style="color: red;">fail</span></li>
						<li class="fragment">положить в очередь = <span class="fragment" style="color: red;">fail</span></li>
					</ul>
					<p class="fragment">Не заложили отказы в дизайн системы</p>
					<img class="fragment" src="images/depression.jpg" height="300px"/>
				</section>
				<section>
					<h2>CAP-теорема</h2>
					<img class="fragment" height="400px" src="images/cap_theorem.png"/>
					<p class="fragment">Три стула: выбирай любые два<span class="fragment">*</span></p>
					<p><small>[1]: <a href="http://www.infoq.com/articles/cap-twelve-years-later-how-the-rules-have-changed">E.Brewer, CAP twelve years later: How the "rules" have changed.</a></small></p>
					<aside class="notes">
						"система с общим состоянием может иметь только два из трех следующих свойств:
						целостность данных, постоянная доступность и устойчивость к сетевым сбоям".
						Теорема озвучена ериком бревером еще в 2000,
						формально описана и неформально доказана пару лет позже.
						Но есть несколько тонкостей с её применением.
					</aside>

				</section>
				<section>
					<h2>C<span class="fragment highlight-red">A</span>P: Availability</h2>
					<ol class="fragment">
						Постоянная доступность:
						<li class="fragment">Каждый запрос к системе</li>
						<li class="fragment">К любому живому узлу</li>
						<li class="fragment">Должен быть успешно обработан</li>
					</ol>
					<br/><br/>
					<ul>
						<li class="fragment">Часть запросов откладывается на потом <span class="fragment" style="color: red;">☹</span></li>
						<li class="fragment">Не все живые узлы отвечают на запросы <span class="fragment" style="color: red;">☹</span></li>
						<li class="fragment">500 internal server error <span class="fragment" style="color: red;">☹</span></li>
					</ul>
					<aside class="notes">
						нетсплит может длиться вечно, откладывать запросы нельзя
					</aside>
				</section>
				<section>
					<h2>Целостность</h2>
					<p><span class="fragment">A<span style="color: red;">C</span>ID?</span> <span class="fragment">Линеаризуемость!</span></p>
					<ol>
						<li class="fragment">Для всей последовательности операций</li>
						<li class="fragment">должен существовать хотя бы один их порядок</li>
						<li class="fragment">где каждая операция мгновенна</li>
					</ol>
					<aside class="notes">
						операция не размазана во времени
					</aside>
				</section>
				<section>
					<h2>Линеаризуемость</h2>
					<p>Регистр, один читатель-писатель:</p>
					<img height="120px" src="images/consistency_single.svg" class="plain"/>
					<p>Несколько читателей и писателей:</p>
					<img height="200px" src="images/consistency_multi.svg" class="plain"/>
				</section>
				<section>
					<h2>Линеаризуемость</h2>
					<p>Реальный мир с сетевыми задержками:</p>
					<img src="images/consistency_real.svg" class="plain" height="250px"/><br/>
					<ul>
						<li>r<sub style="font-size: 15pt">0</sub>=a, w<sub style="font-size: 15pt">1</sub>=b, r<sub style="font-size: 15pt">1</sub>=b</li>
						<li>r<sub style="font-size: 15pt">0</sub>=a, r<sub style="font-size: 15pt">1</sub>=a, w<sub style="font-size: 15pt">1</sub>=b</li>
						<li class="fragment highlight-red">r<sub style="font-size: 15pt">0</sub>=a, r<sub style="font-size: 15pt">1</sub>=b, w<sub style="font-size: 15pt">1</sub>=b</li>
					</ul>
				</section>
				<section>
					<h2>Линеаризуемость для чайников</h2>
					<ul>
						<li>Операции могут произойти в любой последовательности</li>
						<li>Мы точно не знаем в какой</li>
						<li>∃ !1 непротиворечивая последовательность</li>
					</ul>
					<img src="images/jmm.jpg" height="300px"/><br/>
				</section>
				<section>
					<h2>CA<span class="fragment highlight-red">P</span>: Partition tolerance</h2>
					<p>устойчивость к сбоям сети</p>
					<p style="height: 300px;">
					  <img class="fragment plain" height="250px" src="images/split_fail_bg.svg"/>
					  <img class="fragment plain" height="250px" style="position: relative; top:-300px;"src="images/split_fail_fg.svg"/>
					</p>
					<p class="fragment">Настал netsplit: кластер развалился пополам. Что делать?</p>
					<ul>
						<li class="fragment">Большая половинка живет, меньшая лежит</li>
						<li class="fragment">Работают обе половинки</li>
					</ul>
					<aside class="notes">

					</aside>
				</section>
				<section>
					<h2>CP / AP / AC</h2>
					<p class="fragment">Проблема с АС:<br/>нужен идеальный мир c идеальной сетью</p>
					<img class="fragment" src="images/rainbow_unicorn.gif" height="400px"/>
  				<aside class="notes">
							C+A - легко, когда у вас идеальная сеть в вакууме. С+А на ненадежной сети - невозможно (почему?)
							т.е. если у вас сеть сделана не из радуги и бабочек, то вы не можете С+А.
							есть выбор только между CP/AP
					</aside>
				</section>
				<section>
					<h2>CP / AP / AC</h2>
					<img class="plain" src="images/cp_vs_ap.svg" height="300px"/>
					<p class="fragment">В реальном мире можно выбирать CP или AP,<br/> третьего не дано</p>
				</section>
				<section>
					<h2>CP / AP / AC в реальной жизни</h2>
					<p><img src="images/cap_methods.png" class="plain" height="350px"/></p>
					<ul>
						<li>2PC: двухвазный коммит</li>
						<li>Paxos: голосование с кворумом</li>
						<li>Gossip: peer-to-peer обмен</li>
					</ul>
				</section>
				<section  data-background="images/head-boom.gif" data-background-transition="none">
				</section>
				<section>
					<h2>Jepsen: Call me maybe</h2>
					<img src="images/aphyr.jpg" height="350px"/>
					<ul>
						<li>Фреймворк на Clojure для тестирования р/с</li>
						<li>Набор готовых тестов для разных систем</li>
						<li>Серия разгромных статей о найденных проблемах</li>
					</ul>
				</section>
				<section>
					<h2>Jepsen: чтобы шатать</h2>
					<p><small>MongoDB, Aerospike, Cassandra, Kafka, MariaDB/Galera, Percona, RabbitMQ,<br/> Redis, Riak, Zookeeper, etcd, Chronos, RethinkDB</small></p>
					<img height="300px" src="images/jepsen.jpg"/>
					<ul>
						<li>Имитация сетевых ошибок</li>
						<li>Генерация случайных последовательностей операций</li>
						<li>Оценка истроий применения операций с т.з. целостности</li>
					</ul>
					<!--p><small>[1]: <a href="http://jepsen.io">Jepsen, Distributed Systems Safety Analysis</a></small></p-->
				</section>
				<section data-background="images/bsod1.png" data-background-transition="none"></section>
				<section data-background="#000000" data-background-transition="none"></section>
				<section data-background="images/bios2.jpg" data-background-transition="none"></section>
				<section data-background="#000000" data-background-transition="none"></section>
				<section data-background="images/bsod3.jpg" data-background-transition="none"></section>
				<section data-background="#000000" data-background-transition="none"></section>
				<section>
					<h2>Live demo</h2>
					<p>План:</p>
					<ul>
						<li class="fragment">
							Master-slave распределенная система, Scala+Akka+Docker
							<ul style="color: grey;">
								<li>Async replication</li>
								<li>Sync replication</li>
							</ul>
						</li>
						<li class="fragment">Тестировать её при помощи Jepsen, не шатать</li>
						<li class="fragment">Пытаться обьяснить результат</li>
					</ul>
				</section>
				<section>
					<img class="plain" height="400px" src="images/master_slave.png"/>
				</section>
				<section>
					<h2>Master/slave</h2>
					<img class="plain" height="250px" src="images/master_slave.svg"/>
					<ol>
						<li>Клиент отправляет запрос на запись мастеру</li>
						<li>Мастер пишет на диск</li>
						<li>Мастер [а]синхронно реплицирует запись слейву</li>
						<li>Мастер отвечает клиенту об успешной записи</li>
					</ol>
					<p><strong>Async/sync replication == CA?</strong></p>
				</section>
				<section>
					<h2>Docker</h2>
					<p><img src="images/docker_orig.png" height="200px" class="fragment"/> <img src="images/docker.png" height="200px" class="fragment"/></p>
					<p><ul>
						<li class="fragment">Система контейнеризации приложений</li>
						<li class="fragment">Использует Linux cgroups (LXC, OpenVZ)</li>
						<li class="fragment">Богатая экосистема: Compose, Machine, Swarm, Kubernetes</li>
					</ul></p>
				</section>
				<section>
					<h2>Jepsen + M/S</h2>
					<img class="plain" src="images/jepsen_ms.svg" height="350px">
					<ul>
						<li>Писать в мастер, читать с мастера/слейва</li>
						<li>Consistency = ?</li>
						<li>Availability = ?</li>
					</ul>
				</section>
				<section>
					<h2>Clojure 101</h2>
					<img src="images/habr_clojure_tr.png" height="250px"/>
					<p><ul>
						<li>(+ 2 2)</li>
						<li>(defn hello [name] (println "hello, " name "!"))</li>
					</ul></p>
				</section>
				<section>
					<h2>Jepsen 101</h2>
					<p><img src="images/jepsen_internal.svg" class="plain" height="600px"/></p>
				</section>
			  <section>
					<h2>Master/Slave Fail</h2>
					<img class="plain" height="350px" src="images/ms_fail.svg"/>
					<ul>
						<li>Мастер говорит ОК когда слейв не консистентен</li>
						<li>Слейв запаздывает за мастером</li>
				  </ul>
			  </section>
				<section>
					<h2>Что-то не так</h2>
					<p class="fragment">
					  <img src="images/willis_perfect.jpg" height="400px"/>
						<img src="images/willis_real.jpg" height="400px"/>
					  <small>до разработки &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbspво время разработки</small>
				  </p>
				</section>
				<!--section>
					<h2>Master/Slave fail #2</h2>
					<img class="plain" height="300px" src="images/ms_fail_ava.svg"/>
					<p>В случае нетсплита, слейв:</p>
					<ul>
						<li>Или отдает неконсистентные данные</li>
						<li>Или не обрабатывает запросы</li>
				  </ul>
				</section-->
				<section>
					<h2>Master/Slave vs CAP</h2>
					<p>Consistency + Availability?</p>
					<ul>
						<li>асинхронная репликация: С = <span style="color: red;">неа</span>, A = <span style="color: green;">да</span></li>
						<li>синхронная репликация: C = <span style="color: green;">да</span>, A = <span style="color: green;">да</span></li>
					</ul>
				</section>
				<section>
					<h2>Налайвкодили, а жить-то как?</h2>
					<img src="images/kolenki.jpg" height="250px"/>
					<p>Крафтовые распределенные системы:</p>
					<ul>
						<li>Содержат кривой-косой алгоритм консенсуса</li>
						<li>Их никто не тестировал на целостность в бою</li>
					</ul>
				</section>
				<section>
					<h2>Консенсус</h2>
					<p>Соглашение об общем состоянии, восстановление от сбоев:</p>
					<ul>
						<li><span style="color: green;">Minority fail</span>: OK</li>
						<li><span style="color: red;">Majority fail</span>: потеря доступности, сохранение целостности</li>
					</ul>
				</section>
				<section>
					<h2>Raft vs Paxos</h2>
					<p>TODO: как работают, чем отличаются</p>
				</section>
				<section>
					<h2>Консенсус и реальная жизнь</h2>
					<p>TODO: в каких системах используется</p>
				</section>
				<section>
					<h2>Консенсус и код</h2>
					<p>TODO: библиотеки и реализации</p>
				</section>
				<section>
					<h2>Live demo strikes back</h2>
					<p>План:</p>
					<ul>
						<li class="fragment">
							Распределенная система, Scala+Akka+Docker
							<ul style="color: grey;">
								<li>Кворум на коленке</li>
								<li>Akka-raft</li>
							</ul>
						</li>
						<li class="fragment">Шатать её при помощи Jepsen</li>
						<li class="fragment">Пытаться обьяснить результат</li>
					</ul>
				</section>
				<section>
					<h2>Ужасный netsplit</h2>
					<p>TODO: почему наш кворум развалился</p>
				</section>
				<section>
					<h2>Akka-raft</h2>
					<p>TODO: описание API, как работать</p>
				</section>
				<section>
					<img src="images/happy_cat.jpg" height="500px"/>
				</section>
				<section>
					<h2>Cheat sheet</h2>
					<img src="images/distsys_cheatsheet.jpg"/>
					<p><small>[1]: <a href="http://book.mixu.net/distsys/single-page.html">M. Takada, Distributed systems for fun and profit.</a></small></p>
					<!-- http://book.mixu.net/distsys/single-page.html -->
				</section>
				<section>
					<h2>Личный опыт</h2>
					<img height="300px" src="images/bike.jpg"/>
					<ul>
						<li>Наигрались в свои велосипеды: master-slave</li>
						<li>Наигрались в чужие велосипеды: akka-cluster</li>
						<li>Вынесли весь стейт в наружу</li>
					</ul>
					<p>Теперь все иммутабельно и пахнет ёлочками.</p>
				</section>
				<section>
					<h2>Выводы</h2>
					<img src="images/easy_way.png" height="350px"/>
					<ul>
						<li>Прострелить ногу очень просто</li>
						<li>Прежде чем изобретать велосипед, учите матчасть</li>
						<li>Почти все проблемы уже решены</li>
					</ul>
				</section>
				<section data-background="images/head-boom.gif" data-background-transition="none">
					<h1>Вопросы?</h1>
				</section>
			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,
				// Transition style
				transition: 'none', // none/fade/slide/convex/concave/zoom

				// Transition speed
				transitionSpeed: 'fast', // default/fast/slow
				slideNumber: true,
				minScale: 0.1,
				maxScale: 2.0,
				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
